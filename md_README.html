<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>superspreader: superspreader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">superspreader
   </div>
   <div id="projectbrief">Party game for simulating zombie infection</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">superspreader </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><object type="image/svg+xml" data="https://github.com/kestrel-labs/superspreader/actions/workflows/ci.yaml/badge.svg" style="pointer-events: none;">ci badge</object> <a href="https://github.com/kestrel-labs/superspreader/actions/workflows/doxygen.yaml?query=branch%3Amain"><object type="image/svg+xml" data="https://github.com/kestrel-labs/superspreader/actions/workflows/doxygen.yaml/badge.svg?branch=main" style="pointer-events: none;">Doxygen</object></a> <a href="https://github.com/kestrel-labs/superspreader/blob/main/LICENSE"><img src="https://img.shields.io/github/license/kestrel-labs/superspreader" alt="license" class="inline"/></a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Quickstart</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Build</h2>
<p>Build a new development image </p><div class="fragment"><div class="line">export UID=$(id -u) export GID=$(id -g); docker compose -f compose.dev.yml build</div>
</div><!-- fragment --><p>Start an interactive development container </p><div class="fragment"><div class="line">docker compose -f compose.dev.yml run development</div>
</div><!-- fragment --><p>Build and upload the health monitor: </p><div class="fragment"><div class="line">username@superspreader-dev:~/ws arduino-cli compile --fqbn esp32:esp32:esp32 src/superspreader/arduino/health_monitor</div>
<div class="line">username@superspreader-dev:~/ws arduino-cli upload -p /dev/ttyUSB0 --fqbn esp32:esp32:esp32 src/superspreader/arduino/health_monitor</div>
<div class="line">username@superspreader-dev:~/ws arduino-cli monitor -p /dev/ttyUSB0 -c baudrate=115200</div>
</div><!-- fragment --><p>On the host, be sure to run these commands so the container has permissions to upload to the hardware. </p><div class="fragment"><div class="line">sudo chmod 666 /dev/ttyUSB0</div>
<div class="line">sudo chown $USER /dev/ttyUSB0</div>
<div class="line">sudo adduser $USER dialout</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
System Design</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
Modules</h2>
<p>Communication between the Hardware and Game Event Loop modules is done via message queue. Hardware events are placed in the queue by the Hardware module then the Game is ticked. The Game then processes the events, using the Player Engine to update the state of the game. The Player Engine also executes context dependent closures passed to it while processing events, such as playing animations or setting global state. </p><div class="fragment"><div class="line">graph</div>
<div class="line">    A[Hardware] --&gt; B[(Game Message Queue)]</div>
<div class="line">    B --&gt; C[Game Event Loop]</div>
<div class="line">    C --&gt; D[(Hardware Message Queue)]</div>
<div class="line">    D --&gt; A</div>
<div class="line">    C -..-&gt; E[Player Engine]</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md5"></a>
Persistent player state</h3>
<p>To conserve power, the system goes to deep sleep after processing events. To allow game state to persist, it is stored in special hardware memory (called RTC) and represented as a struct from the Player Engine. When the Hardware ticks the Game it sends the current player state. Then the Game calls functions from the Player Engine to transform the state based on the events it received from hardware. Once all messages are processed the persistent state is passed back to the hardware and the new state is stored in RTC memory before sleep.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Hardware Module</h3>
<p>The hardware subsystem performs these steps on each wake-up: </p><div class="fragment"><div class="line">graph TD</div>
<div class="line">    A(Wakeup) --&gt;B[Scan Bluetooth]</div>
<div class="line">    B --&gt; C[(Exposure Hw Msg)]</div>
<div class="line">    C --&gt; D{Treatment?}</div>
<div class="line">    D --&gt;|Yes| E[(Treatment Hw Msg)]</div>
<div class="line">    E --&gt; F</div>
<div class="line">    D --&gt;|No| F[Tick Game]</div>
<div class="line">    F --&gt; Z{Game Msgs?}</div>
<div class="line">    Z --&gt;|Yes| G[Animate Game Msgs]</div>
<div class="line">    G --&gt; H(Sleep)</div>
<div class="line">    Z --&gt;|No| H</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Game Module</h3>
<p>The Game event loop processes the messages placed in the queue from the hardware on each tick. </p><div class="fragment"><div class="line">graph TD</div>
<div class="line">    A(Tick) --&gt;B{Pop Hw Msg}</div>
<div class="line">    B -------&gt;|None| Z(Return)</div>
<div class="line">    B ---&gt;|Treatment| E[Process Treatment]</div>
<div class="line">    E ---&gt; C[(Treatment Game Msg)]</div>
<div class="line">    C --&gt; B</div>
<div class="line">    B --&gt;|Exposure| G[Process Exposure]</div>
<div class="line">    G ---&gt; J[(Exposure Game Msg)]</div>
<div class="line">    J --&gt; B</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
Player Engine</h3>
<p>The player engine provides functions that transform the state based on events and the current state. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
